(()=>{var b=Object.defineProperty;var o=(i,e)=>b(i,"name",{value:e,configurable:!0});async function m(){Hooks.on("renderChatMessage",async(i,e,t)=>{if(!i.content.includes("d2fvtt-message"))return;let s=document.createElement("i");s.classList.add("fa-brands","fa-discord"),s.title=e.find(".d2fvtt-message").attr("data-discord-channel"),e.find("header.message-header").first().prepend(s)}),await Promise.all(game.messages.map(async i=>{if(i.content.includes("d2fvtt-message"))return i.update()}))}o(m,"setup");var r={Hello:10,Heartbeat:1,HeartbeatAck:11,Identify:2,InvalidSession:9,Ready:0,Reconnect:7,Resume:6};var l={encoding:"json",gatewayUrl:"wss://gateway.discord.gg",version:10},f={Closed:"closed",Established:"established",Open:"open"},h=class extends EventTarget{static{o(this,"Listener")}#e;#s={heartbeatAcknowledged:!0,heartbeatInterval:-1,gatewayUrl:"",sessionId:"",seq:null,status:f.Closed};#t={active:!1,toggle:!0,icon:"fa-brands fa-discord",name:"discord",title:`${n}.name`,onClick:this.onToolbarToggle.bind(this)};set acceptedChannels(e){e?this.acceptedChannelIds=e.split(","):this.acceptedChannelIds=[]}set token(e){this.close(),e&&(this.#e=this.buildClient({url:l.gatewayUrl,token:e}))}constructor(){super(),this.acceptedChannels=game.settings.get(n,"discordChannelIds"),this.clientState={...this.#s},Hooks.on("getSceneControlButtons",this.addToggleControlBtn.bind(this))}addToggleControlBtn(e){if(!game.user.isGM)return;e.find(s=>s.name==="token")?.tools.push(this.#t)}buildClient({url:e,token:t}){let s=new WebSocket(`${e}/?v=${l.version}&encoding=${l.encoding}`);return s.addEventListener("open",()=>{this.clientState={...this.#s,gatewayUrl:s.url,token:t,status:f.Open}}),s.addEventListener("close",this.onClose.bind(this)),s.addEventListener("error",this.onError.bind(this)),s.addEventListener("message",this.onReceive.bind(this)),s}close(e=1e3,t=""){this.clientState.hb&&clearInterval(this.clientState.hb),this.#e?.removeEventListener("close",this.onClose),this.#e?.removeEventListener("error",this.onError),this.#e?.removeEventListener("message",this.onReceive),this.#e?.close(e,t),this.clientState={...this.#s},this.#t.active=!1,ui.controls.render()}isValidGuildChannel({channel_id:e,guild_id:t}){return t!==game.settings.get(n,"discordGuildId")?!1:this.acceptedChannelIds.length===0||!!this.acceptedChannelIds.includes(e)}onClose(e){c("Connection closed",e),this.close(),e.code===1006&&this.resume(!1)}onError(e){c("Connection error",e)}onReceive({data:e}){return new Promise((t,s)=>{this._onReceive(JSON.parse(e)).then(t).catch(d=>{c("WS receive error",d),s(d)})})}onToolbarToggle(e){e?this.#e=this.buildClient({url:l.gatewayUrl,token:game.settings.get(n,"discordToken")}):this.close(),this.#t.active=e,ui.controls.render()}resume(e=!0){e&&this.close(3e3,"resume"),this.#e=this.buildClient({resume:!0,url:this.clientState.gatewayUrl,token:this.clientState.token}),this.#e.addEventListener("open",this._sendResume.bind(this))}_destroy(){Hooks.off("getSceneControlButtons",this.addToggleControlBtn)}async _getRenderContent(e){let t=e.content.matchAll(/(?:<[#@](\d+)>)+/g),s=this.clientState.channels[e.guild_id],d=this.clientState.members[e.guild_id];for(let a of t){let u=a[0][1];u==="@"&&d[a[1]]?e.content=e.content.replace(a[0],`<u>@${d[a[1]].display}</u>`):u==="#"&&s[a[1]]&&(e.content=e.content.replace(a[0],`<u>#${s[a[1]].name}</u>`))}return renderTemplate(`modules/${n}/static/templates/chat-card.hbs`,{message:e,attachments:e.attachments.map(a=>({filename:a.filename,image:a.content_type?.startsWith("image")??!1,url:a.url,video:a.content_type?.startsWith("video")??!1})),channel:this.clientState.channels[e.guild_id][e.channel_id]?.name,content:e.content})}_onGuildJoin(e){this.clientState.channels??={},this.clientState.channels[e.id]=e.channels.filter(t=>t.type===0).reduce((t,s)=>({...t,[s.id]:{name:s.name,type:s.type}}),{}),this.clientState.members??={},this.clientState.members[e.id]=e.members.filter(t=>!t.pending).reduce((t,s)=>({...t,[s.user.id]:{avatarId:s.avatar??s.user.avatar,display:s.nick??s.user.display_name??s.user.username,username:s.user.username}}),{})}async _onMessageCreated(e){let t=game.users.find(s=>s.getFlag(n,"did")===e.author.username);return ChatMessage.create({author:t?.id,content:await this._getRenderContent(e),flags:{[n]:{managed:!0,messageId:e.id}},speaker:{actor:t?.character,alias:t?.character?.name??t?.name??e?.member?.nick??e?.author?.username},style:1})}async _onMessageDeleted(e){let t=game.messages.find(s=>s.getFlag(n,"messageId")===e.id);return t?game.settings.get(n,"preserveDeletedMessages")?t.update({content:t.content.replace('class="d2fvtt-message"','class="d2fvtt-message deleted"')}):t.delete():Promise.resolve()}async _onMessageUpdated(e){let t=game.messages.find(s=>s.getFlag(n,"messageId")===e.id);return t?t.update({content:await this._getRenderContent(e)}):Promise.resolve()}async _onReceive(e){c("Received message (hi)",e);let{d:t,op:s,s:d,t:a}=e;switch(s){case r.Hello:this.clientState.heartbeatInterval=t.heartbeat_interval,setTimeout(()=>{this._sendHeartbeat(),this.clientState.hb=setInterval(this._sendHeartbeat.bind(this),this.clientState.heartbeatInterval)},this.clientState.heartbeatInterval*Math.random()),this._sendIdentify();break;case r.Heartbeat:this._sendHeartbeat();break;case r.HeartbeatAck:this.clientState.heartbeatAcknowledged=!0,this.clientState.status==="open"&&this._sendIdentify();break;case r.InvalidSession:t?this.resume():(this.close(),this.#e=this.buildClient({url:l.gatewayUrl,token:this.clientState.token}));break;case r.Ready:a==="READY"&&(this.clientState.gatewayUrl=t.resume_gateway_url??this.clientState.gatewayUrl,this.clientState.sessionId=t.session_id??this.clientState.sessionId,this.clientState.seq=d??this.clientState.seq,this.clientState.status="ready",this.#t.active=!0,ui.controls.render());break;case r.Reconnect:this.resume();break}if(this.clientState.status==="ready")if(a==="GUILD_CREATE")this._onGuildJoin(t);else{if(!t||!this.isValidGuildChannel(t))return;switch(a){case"MESSAGE_CREATE":return this._onMessageCreated(t);case"MESSAGE_UPDATE":return this._onMessageUpdated(t);case"MESSAGE_DELETE":return this._onMessageDeleted(t)}}}_sendHeartbeat(){this.#e&&this.#e.readyState===WebSocket.OPEN&&(this.clientState.status==="ready"&&!this.clientState.heartbeatAcknowledged?(this.close(),this.resume()):(this.clientState.heartbeatAcknowledged=!1,this.#e.send(JSON.stringify({op:r.Heartbeat,d:this.clientState.seq}))))}_sendIdentify(){this.#e.send(JSON.stringify({op:r.Identify,d:{intents:33537,properties:{browser:window.navigator.userAgent,device:"DiscordToFVTT"},token:this.clientState.token}}))}_sendResume(){this.#e.removeEventListener("open",this._sendResume),this.#e.send(JSON.stringify({op:r.Resume,d:{session_id:this.clientState.sessionId,seq:this.clientState.seq,token:this.clientState.token}}))}};var n="discord-to-fvtt",c=o((i,...e)=>console.log(n,"|",i,...e),"log"),g;Hooks.once("setup",()=>{game.settings.register(n,"discordGuildId",{name:"Discord Server ID",hint:"Enter your Discord server ID.",config:!0,requiresReload:!1,scope:"world",type:String}),game.settings.register(n,"discordChannelIds",{name:"Discord Channel IDs",hint:"Enter a list of channel ID filters, separated by commas. Leave this blank to relay all accessible channels.",config:!0,requiresReload:!1,scope:"world",type:String,onChange:o(i=>g.acceptedChannels=i,"onChange")}),game.settings.register(n,"discordToken",{name:"Discord Token",hint:"Enter your Discord bot token if you want to use your own bot.",config:!0,requiresReload:!1,scope:"world",type:String,onChange:o(i=>g.token=i,"onChange")}),game.settings.register(n,"preserveDeletedMessages",{name:"Preserve Messages",hint:"Should deleted messages be preserved in the chat log (with a strike-through)?",config:!0,requiresReload:!1,scope:"world",type:Boolean}),m().catch(i=>console.error(n,{error:i})),g=new h});Hooks.once("ready",()=>{game.users.activeGM.isSelf&&(g.token=game.settings.get(n,"discordToken"))});var p={default:"section.window-content > div footer",pf2e:"section.tab[data-tab=core] > div footer",pirateborg:"section.window-content > div fieldset:last-child"};Hooks.on("renderUserConfig",(i,e)=>{let t=i.document.flags[n]?.did??"",s=`
    <fieldset>
      <legend>${game.i18n.localize(`${n}.name`)}</legend>
      <div class='form-group'>
        <div class='form-fields'>
          <input type='text' name='flags.${n}.did' value='${t}' placeholder='Discord User ID'>
        </div>
        <p class='hint'>${game.i18n.localize(`${n}.userConfigurationHint`)}</p>
      </div>
    </fieldset>`;e.querySelector(p[game.system.id]??p.default).insertAdjacentHTML("beforebegin",s)});})();
//# sourceMappingURL=index.js.map
